DECLARE ns6 NAMESPACE 'http://www.gruppoiren.it/CORPORATE_DOCUMENTALE';
DECLARE ns NAMESPACE 'http://prodoc.iren.it/protocollo';

CREATE COMPUTE MODULE FLUX_ALFRESCO_EnqueueRequest
	CREATE FUNCTION Main() RETURNS BOOLEAN
	BEGIN
		-- IN QUESTA PARTE DI CODICE, SI VUOLE UNIFORMARE IL NS DI INPUT AD UN UNICO NOME.
		-- SI è CAMBIATO IL DOMINIO DEL PARSER DA XMLNSC A BLOB , E SUCCESSIVAMENTE SI è FATTO UN REPLACE NEL DOCUMENTO DI INPUT DEL TAG
		-- CORRISPONDENTE.
		DECLARE idFluxChar CHARACTER LEFT(TRANSLATE(UUIDASCHAR, '-', ''), 24); --|| CAST(CURRENT_TIMESTAMP AS CHARACTER FORMAT 'HHmmSSSS');
		DECLARE idFluxByte BLOB CAST(idFluxChar AS BLOB CCSID 1208); 
		SET Environment.Variables.idFlux = idFluxChar;
	    DECLARE NonPrintable BLOB X'0001020304050607080B0C0E0F101112131415161718191A1B1C1D1E1F7F808182838485868788898A8B8C8D8E8F909192939495969798999A9B9C9D9E9FA0A1A2A3A4A5A6A7A8A9AAABACADAEAFB0B1B2B3B4B5B6B7B8B9BABBBCBDBEBFC0C1C2C3C4C5C6C7C8C9CACBCCCDCECFD0D1D2D3D4D5D6D7D8D9DADBDCDDDEDFE0E1E2E3E4E5E6E7E8E9EAEBECEDEEEFF1F2F3F4F5F6F7F8F9FAFBFCFDFEFF';
	    DECLARE Printable    BLOB X'20202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020';
	    DECLARE Fixed        BLOB TRANSLATE(InputRoot.BLOB.BLOB, NonPrintable, Printable);
		DECLARE inBitstream      CHARACTER CAST(Fixed AS CHARACTER CCSID 1208);
		
		--||LOG REQUEST
		INSERT INTO Database.IIB_FLUX_PROTOCOLLO 
		(ID_FLUX, RICHIESTA_FLUX, TMS_RICHIESTA_FLUX)
		VALUES
		(idFluxChar, inBitstream, CURRENT_TIMESTAMP);
		
	 	DECLARE nsModifica  CHARACTER 'http://prodoc.iren.it/protocollo/modifica-documento';
		DECLARE nsInserisci CHARACTER 'http://prodoc.iren.it/protocollo/invio-documento';
		DECLARE nsCancella CHARACTER 'http://prodoc.iren.it/protocollo/cancella-documento';
		
		DECLARE data_protocollo  CHARACTER;
		
		SET inBitstream = REPLACE(inBitstream, nsModifica, ns);
		SET inBitstream = REPLACE(inBitstream, nsInserisci, ns);
		SET inBitstream = REPLACE(inBitstream, nsCancella, ns);
		 
		SET OutputRoot.MQMD.CorrelId = idFluxByte;
		CREATE LASTCHILD OF OutputRoot DOMAIN('XMLNSC') PARSE(inBitstream CCSID 1208);
		
		--||LOG NUMERO PROTOCOLLO
		UPDATE Database.IIB_FLUX_PROTOCOLLO AS T
		SET NUMERO_PROTOCOLLO = OutputRoot.XMLNSC.ns:documenti.ns:documento.ns:numero_protocollo WHERE T.ID_FLUX = Environment.Variables.idFlux;
		
		
		--||LOGICA RECLAMI
		DECLARE doc REFERENCE TO OutputRoot.XMLNSC.ns:documenti.ns:documento;
		IF doc.ns:societa.ns:codice = 'RET' THEN
			IF doc.ns:tipo_protocollo = 'P' THEN
				IF (doc.ns:riferimento_IREN IS NOT NULL AND doc.ns:riferimento_IREN <> '') THEN
					--||RECLAMO TIPO PARTENZA
					PROPAGATE TO TERMINAL 'out1';
					RETURN FALSE;
				END IF;
			END IF;
			
			IF doc.ns:tipo_protocollo = 'A' THEN
				IF doc.ns:voci_titolario.ns:voce_titolario.ns:codice = '1' OR OutputRoot.XMLNSC.ns:documenti.ns:documento.ns:voci_titolario.ns:voce_titolario.ns:codice = '2' THEN
					--||RECLAMO TIPO ARRIVO
					PROPAGATE TO TERMINAL 'out1';
					RETURN FALSE;
				END IF;
			END IF;
		END IF;
		
		RETURN TRUE;

	END;

END MODULE;
